#include "maskApi.h"
#include <stdio.h>
#include <stdlib.h>

siz H = 1080;
siz W = 1920;

/*  
    Marcelo Armengot (featuring)
        +Piotr Dollar (starring)
        +Tsung-Yi Lin (starring)
        https://github.com/cocodataset/cocoapi
        (C) 2015 (maskapi <- pycocotools)

    COMPILATION:
        gcc -c maskApi.c -o maskapi.o 
        gcc -g -Wall testjson.c maskapi.o -o test2
*/

byte** reshape(byte *in, siz h, siz w)
{
    int k=0;
    siz i,j;
    byte **out = malloc(h*sizeof(byte*));
    
    for (i=0;i<h;i++)
    {                
        out[i] = (byte*)malloc(sizeof(byte)*w);        
        for (j=0;j<w;j++)
        {            
            out[i][j] =  in[h*j+i];
            k = k + 1;
        }        
    }
    return(out);
}

void freemat(byte **fmask,siz h)
{
    siz i;
    for (i=0;i<h;i++)
    {
        free(fmask[i]);        
    }
    free(fmask);    
}

int main()
{   
    char *output,input[] = "^\\a7110bQ17J5M3L3M3M3iHAQ]O3\\IL[i0i0f\\O[OSJKSi0T1`\\ORO`JKmh0T1b\\OPOdJKhh0W1PWOoNk40`KJch0X1SWOPOf4MgKK]h0Y1YWOQO]4JQLLXh0Y1[WOROX4JWLKTh0Y1`WOSON_Oa39PMMog0Y1cWOSOK@_38VMLlg0d0]WO]O9n0X2kNnM8<Ngg0b0eWOYO3U1U2lNmM7a0Mdg0a0_XO?^1oNjM3i0M`g0b0_XO?^1POiM1l0N\\g0c0`XO??nNoN4GMR1OXg0c0aXO?=SOmN1JKT1OVg0d0VYOKF4aNH6FX1OUg0d0XYO1ZOg0POeNZ1OSg0n0PYO<kN7DbN^1MRg0T1lXOa2bN_L_1MRg0W1jXOk26mKPg0Y1hXOk27mKQg0Z1fXOi29mKPg0\\1fXOg2:mKQg0^1aXOf2>lKQg0a1^XOb2b0lKif0JiWOj1k0c1]OoLV1Kid0I_[O1ZNi1X1S1QOaMU1Hcd00d[OM\\Na1T2`0RN]NW1E^d03j[OL[NT1n2;VMoNY1CYd07o[OI\\NR1]3McL_O]1BTd09T\\OH\\NP1V1ROd0d0TNH]1BPd0<Y\\OF\\Nm0V1ROe0e0SNH]1Blc0>]\\OG]Ni0GjN\\16g0j0SNF]1Ajc0`0W\\O[OaN=4^1=XN\\1m0SNE^1Afc0a0Z\\O[OaN=6U2i1]NRNE]1_Oec0c0]\\OZO`N?7P2g1bNSNKU1WOjc0e0_\\OYOaN`08j1g1gNRN5j0lNRd0f0b\\OYOaNb08d1IUNV1f0jNc0;]N^d0h0e\\OWObNd08]1HoNb02]Oo0OQNhd0h0h\\OWObNf09V1FSOd04[OZ1fd0]Ni\\OWOcNg0<o0CTOh09WOY1dd0]Nl\\OWOcNj0`0b0^O^Ok08TOZ1ad0_Nn\\OUOeNm0f05WOLi03VO[1_d0_NP]OVOfNP1Y1WOdNm0a0M]OmNOR2^d0jNS]OUOgNT1j16]NIBiN2T2Yd0mNT]OTOiNZ1a13aNFGdN6V2Rd0POU]OSOcNH2k1[1MiNE7f0jc0ROW]OSOaNJ4e2<ROFE9c0gc0VOX]OQOcNJ4R3MeNNVN0`1b0?cc0\\OV]OoNeNK5o2LhNMUN2_1e0;`c0In\\OeNmNN6k2KkNLTN3_1g09]c06d\\O[NXON7h2JQON^Ok08Yc0>`\\OTN]O09e2HSOM_Ol07Xc0f0Y\\OmME0:b2GUOM_Ol06Yc0h0W\\OkMF3;^2EXON_O6bN9c1ec0EP\\OC6\\OH3>X2D\\OLA4dN9ODW1Sd0OV\\O_OO@I3`0V2GYOFG5eN6LIX1Qd0N^\\OYOFGJ5c0P2l0KbNQN4ILX1Qd0Nb\\OTOCLI6e0l1W1AUN`N2GMY1Qd0Mj\\OnN[O2J8i0d1Y1BoMhNND2X1Pd0No\\OiNWO7I9l0_1W1DoMROOd0Pd0N]]OPObN;T1T1QOTOh0h0TOTOOHN7Sd0b0^]OPOaN<b1c0eN734GUOOF18Pd0c0]]OPObN>W2HVNU1EN0VOOD29mc0d0_]OPOaN?\\3i0fLhN5b0KNNC2:nc0c0^]OQObN`0]3e0eLoNQ1<mNA3:nc0d0]]OPObNc0a3?aLYOj06UO@1<nc0c0^]OQObNd0b3;_LDb0M^O_O1>nc0b0^]OPObNh0Z1SOf0R1QNN:GF]O0?oc0b0^]OQObNi0U1WOl0i0PN\\10iMO`0Pd0a0^]OPOcNl0Q1WOR1c0nM`1OhMOa0Pd0a0^]OPObNQ1k0UO\\1>jMb11gMNa0Pd0b0^]OPOcNT1e0SOf1:eMe10fM0b0oc0b0]]OQOcN_2`2oMaM0Oh01eN0b0nc0c0^]OPOcN^2e2lM\\M35e0KhN0b0oc0c0^]OPObN6Nj1h2XN[M5<?EnNOc0nc0d0^]OPOcN44i1o1jMYN>E6c0:]OUOOb0oc0d0^]OoNdN56j1g1nM]N6F9h05XOZOOa0Pd0d0]]OQOcN5<h1]1SNcNOE<n0ORO_OOb0oc0e0^]OPOcN4`0j1U1VNfNIFc0l0FTOCOb0oc0e0]]OPOdN5d0g1n0]NiN@Fm0m0ZOSOHOc0nc0e0_]OPOcN5g0i1f0_NmNYOHV1j0POTOL1a0nc0g0]]OQOcN5l0f1?eNVO`0:gNVO01a0nc0g0]]OPOdN5o0h17iNVOa08`N]O00a0nc0h0^]OPOcN5S1h1OlNYOa05]N@10`0oc0h0]]OPOdN6W1f1GRO\\O`0OYNG10`0oc0g0^]OQOcN6[1e1@VOA=0YNE`0mc0i0^]OQOdN4_1g1WOZOF8LYNI?nc0j0]]OPOdN6c1e1PO_OLOG^NK?nc0j0]]OPOdN6f1f1hNC2FEcNK=oc0k0]]OQOcN5l1e1`NF9_OAgNK>oc0k0]]OPOdN6n1f1YNF`0[O]OjNL>nc0k0^]OQOdN5R2g1oMFm0SOVOQOL=oc0l0]]OPOdN7U2f3oNhKjNj05XOM=oc0l0\\]OQOeN6[2`3iMQLm0b0QO\\OO>mc0m0]]OPOeN7]2\\3iM[Lg06TOB0<nc0m0]]OPOdN;_2U3kM`Ld0IoN13M1<nc0m0\\]OQOeN=_2o2PNfL8EXOO2O1=mc0l0]]OROcNa0a2f2VNkLLDEOK<mc0n0]]OPOdNf0_2_2\\NQM^OB6:`c0n0]]OPOdNi0`2?aM0Q1nNoND<9bc0m0\\]OQOdNm0a25fM0R1YOUOFbc0n0]]OPOdNQ1`2NkM0T1WOlNMdc0m0\\]OQOeNT1`2FnM1U1VOhN0ec0n0[]OQOdNX1b2^ORN0U1UOcN7ec0l0\\]OQOdN]1`2VOWN0T1VOaN9dc0n0[]OQOeN`1`2nN[N0e1Baa0o0Z]OQOdNd1a2gN_NOa1Eba0o0Y]OROeNh1`2^NdNO^1Fba0T1W]OQOeNk1`2XNhNN[1Gca0V1V]OQOgNn1\\2SNmNMfe0Q1ZZOQOjNn1W2RNROKce0T1YZOROoNm1o1QNYOIae0W1XZOROQOo1i1oM]OI`e0W1YZOROROR2d1mMAH`e0W1YZOROROV2`1hMFH`e0X1XZOROROJBU2k1oMHI`e0W1YZOROROJFV2b1oMMHhNNE0^f0Y1nZOROROIJX2Z1nM1HhN0CO_f0X1oZOROQOJKZ2W1jM5HiN5oe0S1oZOSOROHL`2Q1eM9IfNMG8[f0Q1Q[OSOROIKb2n0dM<HeNOH5Zf0S1R[OROROIKf2j0_Ma0HeN<Pf0l0S[OROQOIM:Gk1o0PNd0HeN<Pf0l0R[OROSOIL9Ll1e0QNh0HgN:oe0o0P[OPOTOIN9Mn1?oMl0HgN:oe0R1mZOmNWOIN9MR2;kMo0HjN9me0U1jZOlNZOHN9MU27hMT1HjN7me0[1eZOgN_OHN9MZ22dMX1HjN7me0]1cZOeN@IO8M]2OaM[1HkN6ke0c1_ZOaNEGO:La2K\\Ma1GlN6ie0Q1gYOXOf0KHHN9Me2FZMd1GdNOL6Vf0P1kYOZO>JLHN9MT3Z1bLdN>Rf0g0nYOZO8JNH09LT3Z1bLeN<Rf0i0PZOZO1K2G09KT3\\1aLeN=Qf0i0RZO[OLI6G09KU3Z1bLgN;Pf0i0UZO[OHJ7G09KU3Z1bLgN;Pf0j0WZOWOFM6G19KU3[1aLhN:oe0l0XZOUOCO8G08LV3Y1bL^NN5;Uf0k0[ZOTO@27F27KW3Y1bL^N00<Yf0i0`ZOoN\\O57G27LX3W1aL^N219Yf0j0bZOmNYO88F26MZ3U1`L_N308Zf0j0P[OUOSOF25N_3o0\\LfN3N6[f0l0oZOTOTOG15Nc3k0XLjN4N4[f0LeYOf0Z1_OSOH140f3g0ULnN5L2\\f0LgYOe0Y1AROH042i3b0RLTO5I1^f0LhYOe0V1CSOGN64k3>nKXO6IO^f0MiYOd0KZOS1:ZOGN64o3:jK]O?Wf0AkYOd0H_OP16]OIM65R46fK\\OOO?]f0BlYOc0FCn04@HL67U41cK@1O<]f0CmYOb0EFl02BHL67Y4M_KD3N8_f0DnYOb0CGl02BHL67\\4J\\KG4O5^f0FPZO`0@Jm01AIL68e3@fL4\\OM6O1`f0GPZO>_OE100Od09IJK67f3EdLM]O08NNaf0HSZO;\\OH10O3a06MIK58f3IiLGNZg0BeXOI21N5?4NJK59e3LfLD1Q2XOYc04fZOO11N7=11KJ59d32aL_O7n1^O_c0McZO1N0O2=62JK68d34_L]O8m1C^c0HfZO2L030:82JJ69e38ZLXO=l1F]c0EiZO1L030993IJ69e3<ULUOb0j1H]c0CiZO1N020992IK79c3`0SLQOd0i1L_b0_O_\\O1YO1N020992GM96d3a0RLQOd0h1N_b0^O_\\O9WOH40883GM:5d3a0RLQOd0f11_b0\\Oa\\O8WOH4O991GO95d3a0RLQOe0c1EZNOWd0Ib\\O6WOJ20:81GO95d3`0SLROc0c1D_N0Qd0Jc\\O6WOI31981G261h3a0RLSOb0`1FcNOnc0Jd\\O6WOI31892F341j3`0QLVOa0[1HhNOjc0If\\O1VOO0022973F350i3a0RLWO>Y1JkNOgc0Jf\\O1WOM04OO<81G350i3a0RLQOd0^1DnNOec0Ig\\O1\\O8601G350i3a0RLQOd0]1BRO2ac0Hh\\O1\\O8601G3504BS3P1dLQOc0Z1DVO0_c0Ih\\O1^O6332E3614Eo2l0gLSOb0X1EYO1[c0Ii\\O1@3260F4513Im2g0kLVO?T1G^O0Xc0Kh\\O0D0O81G3504Nh2c0oLXO=P1JA0Wc0Ih\\O178]OG35033d2?SM[O;j0MF0Sc0Jh\\O088]OG35035b2=UMQO6M4V1NI0Qc0Ob\\OK>8]OG25149\\29[MPOd0S1CL0ob00a\\OJ?8]OF3604<Y26^MoNe0S1A01lb06Z\\ODf07^OG2603a0V21aMPOf0P1A51ib06Y\\ODg07]OH3414GL:W2?eMPOf0P1@71ib05W\\OFh06]OH3405F1<l1`0jMoNe0o0A;1gb03V\\OHh06]OG3603F6=d1?mMPOf0n0@=2db04V\\OGi06]OG3603E:>]1?PNPOf0n0_O>3eb02T\\OIi06]OG3505D<a0U1=VNoNe0P1^O?4db00S\\OKh07]OG4405D>a0Q1=XNoNe0P1^O`04db0MS\\ONg06^OH3404Da0d0k0:[NPOf0o0^Oa03eb0KR\\O1f06^OH2424Cb0f0g07_NPOf0Q1\\O`05Tc0KY\\O6^OG3505Db0i0a05dNoNe0R1]O`05Rc0KZ\\O6^OG3505Cd0l0<3fNPOf0Q1^O?4Sc0KZ\\O6^OG3504De0o08OjNPOf0Q1_O?3Rc0K[\\O6^OG2604Ee0P14NnNoNe0T1^O>4Pc0K\\\\O5_OH18N2Ge0:QO7o0=ROoNe0T1_O>2Pc0L\\\\O5^OH39K1Je06ZO7c0`0TOPOf0S1_O>3ob0K]\\O5^OH39K1Je05_O7;`0XOQOe0T1_O=3ob0J\\\\O7_OG39H4Mb04D54d0ZOoNe0V1@;2Pc0J\\\\O7_OG39H4Mb03G41f0YOPOf0U1@<2nb0J]\\O7_OG2:H4Na02I4Og0YOPOf0U1A<1mb0J^\\O7_OG29I4Na02L1Ng0YOQOe0X1A:1lb0J_\\O7^OH38I4Na01N1Oe0VOTOe0X1B90nb0H_\\O8^OI19J3Na01N03c0QOXOf0X1G3KVd00jZOI18K4N?02O5`0mN\\Of0X11JA^d00kZOI18J40?O2O8<kN_Oe0Z17C[Odd00kZOI08L40=O5L<:eNDf0Y1a0ZOQOld00lZOI08L41<N6L?6cNHe0Z1h0ROjNRe00mZOJN7O518M:Lb02_NLd0[1R1hNaN[e00mZOJN7O624M=KGN01ZONe0\\1d1Rd0mMoZOKL7280NNa0IH25LIj0CYOR2Ze0lMP[OKK83:1EOg0GH60JMb0N[Oh1^e0lMP[OKK84=f09oNH:NILa02ZOg1]e0lMP[OLL74?e06POI>JLI9;ZOf1]e0kMQ[OLL74c0a01UOJ`0FKK8m2fd0QMQ[OLL74g0=MYOJd0B^O8a0e2ed0PMfZOINN65474j0;IZOKi0_OWO>c0d2ed0nLgZON1N774m09D]OMl0[OROc0d0c2ed0nLfZO99J3R16^OBNm0YOPOd0e0d2dd0mLgZO:8J3U15YOB1n0WOPOf0e05\\O\\1Xe0oMgZO=5G6X14SOD3n0XOoNf0P1ITOf1Ue0QNgZO?3E7\\14lNF6m0XOoNe0S1BZOj1md0UNfZOR1:b03dNH:k0XOPOf0T1BZOf1nd0VNdZOT1:e06XNGd0i0WOPOf0U1C]O_1nd0WNaZOY19i0d0gN3XOoNf0U1F\\OZ1Ue0BcZOl0b0eN5XOoNe0k0\\O[O;>T1Te0GbZOP1>aN9WOPOf0j0^OZO<1@1_1ae0JaZOR1<^N<WOPOf0j0_OZO=MA6X1ce01XZOT1>XNa0XOoNe0k0BWOh04:ie0i2]ZOgLd0WOPOf0j0BYOi035le0l2WZOgLg0WOPOf0j0CYOi032Qf0m2mYOiLl0VOPOe0k0EXOi04MTf0Q3fYOhLo0XOPOd0j0@TON4S14HZf0n3`ZOUKPOd0j0@UON3T15D\\f0n3]ZOWKQOd0j0BTOL3W14@cf0j3XZO]KPOd0i0CVOK2Y14[Ooe0[O[ZO_4`0aKQOc0i0CVOL2Z12WOQf0_O_ZOX4<eKUONN<f0I]OOM\\12SOPf0D`ZOS4;hKYO<a0F^O0J_11oNRf0FcZOR44hK[O>c0C_O2I_10mNRf0JfZOn3NjK\\O`0g0]O@5Hb1LhNVf0MhZOm3GiK_Ob0X1BgNS2Sf0UNiZOl3BhKAd04[Om05POQ2Tf0XNkZOj3[OjKD7N15Jm02ROo1Tf0[NlZOi3VOhKI3171Lj0OVOn1Tf0]NmZOi3oNgK6<JNg0LYOk1Uf0aNnZOf3iNiK8=L=6\\OIj1Wf0bNoZOg3mNULN>5ZOKh1Xf0eNmZOc3lNZLO;6\\OJf1Rf0QNmYOg0X1\\3hNaL0:7[OKe1Qf0RNmYOj0X1V3gNeL187^OKb1Qf0TNmYOl0X1n2gNjL286^OL`1Qf0WNlYOo0W1f2hNnL277_OL_1Pf0YNmYO[1OdNc0a3[ORM370UOO:6]1ne0\\NmYOh1?d1^OUM45OXON:9Y1me0`NlYOk1>[1@ZM34OZON9:X1me0aNkYOn1>T1@]M53M]ON8<U1me0dNjYOo1?n0]OcM70L_ON9=S1le0gNjYOo1>h0_OgM6OLAN7`0R1je0jNiYOP2>b0_OjM7NLCM8b0o0ie0lNjYOP2<?_OmM7MLDM9c0l0ke0nNgYOR2<9^OQN9LKEN9d0j0je0QOfYOP2>6]OUN8KJGO9f0f0je0UOfYOk1`06YOXN3]OM=3IN9h0e0ie0WOfYOg1b06VOZN3@L:4JO9i0c0ie0ZOeYO^1i09nN_N4AJ02M47N8l0`0he0^OeYOT1n0`0gN_N5K4LI9m0>ie0@gYOa0Y1n0XNaN7M0MK9n0<je0BiYOKf1`1gMbN80MMM9P18ke0HiZOBEa1fNdN:4FO06S17ke0K\\ZOG3W1cNeN<h0DDT15me02dYOMk0h0`NeN?j0AFV11ne0f1_ZOQO]NfNb0j0^OHX10Pf0b1_ZOROVOCQOK\\1KRf0a1_ZOSOTODmNO_1GWf0Z1aZOXOmNa0=jN`f0g0gZOI_Nd0<gNbj0b0SUOf0<dNhj0b0mTOh0Sm0ROPSOl0Sm0QOnROn0Wm0mNkROP1Ym0lNiROS1on0O2M2O1O2N1N3N1N3N1O1N3N1N2N3M2LcRh]1";
    RLE encodedmask,decodedmask;
    int x,y,k;
    byte bmask[H*W],*mravel;
    byte **mask=NULL;
    FILE *f=fopen("output.ppm","wb");

    /* source */
    printf("Original RLE:\n");
    printf("%s\n",input);

    /* DECODE */
    rleFrString(&decodedmask,input,H,W);    
    rleDecode(&decodedmask,bmask,1);
    mask = reshape(bmask,H,W);

    /* SAVE IMAGE */
    printf("Saving mask into output.ppm\n");
    fprintf(f, "P6\n%li %li 255\n", W, H);
    for (y=0; y<H; y++) 
    {
        for (x=0; x<W; x++) 
        {
            fputc(mask[y][x]*255, f);
            fputc(mask[y][x]*255, f);
            fputc(mask[y][x]*255, f);
        }
    }
    fclose(f);

    /* ENCODE */
    /* Coco Ravel() style */
    mravel = malloc(sizeof(byte)*(H*W));
    for (x=0;x<W;x++)
    {
        for (y=0;y<H;y++)
        {
            mravel[k] = mask[y][x];
            k++;
        }
    }
    /* RLE <== mask[rows][cols] */
    rleEncode(&encodedmask,mravel,W,H,1);    
    /* RLE->cnts ==> string */
    output = rleToString(&encodedmask);    
    printf("\nRLE encoded after decoding:\n");    
    printf("%s\n",output);

    /* allocated mem free */
    freemat(mask,H);
    rleFree(&encodedmask);
    rleFree(&decodedmask);
    return(0);
}